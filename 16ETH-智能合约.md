# 智能合约
智能合约如何调用？ 
## 在交易中被调用
转账人发起一个交易，如果该交易的被转账者地址是一个合约账户，则视为调用一次智能合约。
如果该交易的被转账者是一个外部账户，则视为一次转账交易。
## 在另一个合约中被调用
一个合约可以调用另一个合约
### 直接调用
如果调用的合约出现异常，则连同调用该合约在内的合约都会被回滚。
### 使用address类型的call()函数
如果调用的合约出现异常，则返回false。但是函数不会抛出异常，而是继续执行.
### 代理调用delegatecall()
delegatecall()只使用给定地址的代码，其他属性(存储、余额等)都取自当前合约。该函数的目的是使用存储在另外一个合约中的库代码。

## payable 关键词
某个函数如果需要收到用户转账，则需要被标志为payable,否则，发起转账会引发错误。

## fallback 函数
当A调用某个函数试图转账时，若该函数不存在，则调用fallback函数。

## 智能合约的创建和运行
+ 智能合约的代码写完之后，要编译成bytecode
+ 创建合约：外部账户发起一个转账交易到0x0地址，转账金额是0，但是要支付汽油费,并且儿合约的代码放在data域中
+ 智能合约运行在EVM(Ethereum Virtual Machine)上
+ 以太坊是一个交易驱动的状态机
+ 调用智能合约的交易发布到区块链上后，每个矿工都会执行这个交易，从当前状态确定性地转移到下一个状态。

## gas汽油费
某个账户发起一个对智能合约的调用，该账户需要支付一定的汽油费。
### gas机制的由来
由于智能合约是一套图灵完备的编程语言，包含循环的操作。当出现死循环时如何解决？
我们由halting problem可以知道，不存在一个程序能够检测出某段代码是否会出现死循环。
那么以太坊引入了汽油费，来限制死循环的出现。
### 执行合约中的指令要收取gas费用，由发起交易的人支付
### EVM中不同指令消耗的汽油费是不一样的
简单的指令很便宜，复杂的或者需要存储状态的指令很昂贵。

### 账户余额不足以支付汽油费时会引起回滚

## 错误处理
以太坊中的交易具有原子性，要嘛全部执行，要嘛全部不执行，不存在执行一半的情况。这边的交易包括转账、智能合约。
### 智能合约中不存在try-catch
### 一旦遇到异常，除特殊情况外，本次执行操作全部回滚
### 可以抛出异常的语句：
+ assert(bool condition):用于内部错误
+ require(bool condition)：用于输入或者外部组件引起的错误
+ revert():终止运行并回滚

## 嵌套调用
+ 指一个合约调用另一个合约中的函数
+ 根据调用的方式，决定是否会引起连锁调用
+ 一个合约向另一个合约转账，没有指明调用哪个函数，仍然会引起调用嵌套(fallback函数)

### 先执行智能合约还是先挖矿
先执行智能合约。
以太坊需要先执行智能合约算出交易者和参与者账户的状态，更新账户树、状态树、交易树，算出三棵树的哈希值，然后在进行挖矿。

### 执行错误的交易，如智能合约，需要发布到区块链吗
需要，因为需要扣除汽油费。

### Solidty能否支持多线程？
Solidity不支持多线程。
以太坊是由交易驱动的状态机，Solidity需要每一步状态都确定，如果采取多线程，可能存在某个线程执行出错，导致无法形成确定的状态。
课题：在多核状态下如何实现确定性重演。

### 每一步都需要是确定的
有没有什么操作，是具有不确定性的。
那就是产生随机数。