# 全节点
1. 一直在线
2. 在本地硬盘上维护完整的区块链信息
3. 在内存里维护UTXO集合，以便快速验证交易的正确性。
4. 监听比特网络上的交易信息，验证每个交易的合法性
5. 决定哪些交易会被打包到区块
6. 监听别的矿工挖出来的区块，验证其合法性
7. 挖矿

# 轻节点
1. 不是一直在线
2. 不用保存整个区块链，只要保存每个区块的块头
3. 不用保存全部交易，只要保存和自己相关的交易 
4. 无法检验大多数交易的合法性，只能检验和自己相关的交易的合法性
5. 无法检测网上发布的区块的正确性
6. 可以验证挖矿的难度(nbits)
7. 只能检测哪个是最长链，不知道哪个是最长合法链。

# 比特币的安全保障
## 密码学性质的保障
密码学保障了攻击者难以伪造签名，难以伪造身份

## 共识机制的保障
# 挖矿机制
比特币系统中大部分节点是轻节点，如果只是转账而不挖矿，那么就没必要运行全节点。挖矿过程中，如果监听到别人发布一个区块，而且该区块是合法的，也在最长合法链上，此时要停止已有在挖的区块，在本地重新组装后选区块，重新挖矿。  
因为要沿着新区块继续挖的话，本地组装的区块中所包含的内容就会发生变化(merkle tree的root 值),指向前一个区块的hash pointer也会发生变化。
但是由于mining puzzle的memoryless(progress freee)性质，所以无论是继续挖原来的区块，还是停下来挖新的区块，成功的概率都是一样的。

# 挖矿设备
挖矿设备的演变趋势:**趋于专业化**.
1. 最早普遍使用普通CPU挖矿，如家用计算机。但效率很低，计算机大部分内存都是闲置的。
2. 后来使用GPU挖矿，效率提高很多，GPU主要用于大规模并行计算。目前比特币挖矿难度提升，已经超出了GPU算力范围。
3. ASIC芯片，性价比高，只能用来挖矿。一个芯片只能为一种加密货币挖矿，除非两种货币的mining puzzle相同(merge mining-有些新兴加密货币为了吸引新的节点采用已有的mining puzzle),研发周期长。

# 矿池
## 好处
挖矿另一个趋势是大型矿池的出现：把矿工组织起来作为一个整体。
好处：减轻了矿工负担，矿工miner只负责计算hash值和nonce，全节点其他职责由pool manager承担。而且解决收益不稳定问题，一旦挖到区块，收益大家一起分配。单矿工存在挖矿时间长，收益不稳定，挖到赚到挖不到就浪费，还要承担全节点所有责任的劣势。(全节点的责任由上文提到。)

## 过程
如果矿工和矿主在不同的地方，矿工要加入一个矿池，按照矿池规定的通讯协议和矿主进行联系。矿主把要计算的哈希值任务分配给矿工，矿工计算完之后把结果返回给矿主，如果有出块奖励大家参与分红。
## 矿工收益分配
不能平均分配，要按照贡献的大小进行分配，需要**工作量证明**.因此pool manager需要降低挖矿的难度，使得收益稳定，因为挖矿难度太高，挖矿的时间过长，导致收益不稳定。如果说原来要求的hash值前面至少要有70个0，那么现在要求60个0就可以，这样挖到的叫做share(almost valid block),挖到后交给矿主，矿主拿到后用作该矿工的工作量。工作量越多，分配的奖励就越多。**可行性在与每个矿工挖到矿的概率，取决于尝试了多少个nonce，尝试的nonce越多，找到的share就越多。**
## 可能存在的问题
### 某个矿工挖到矿，会不会自己偷偷发布，不给矿主？
不可能存在这种情况。
每个矿工的任务由矿主分配，矿主负责组装区块，然后交给矿工组装各种各样的nonce，而且仅仅调整nonce还不够，还要调整coinbase parameter。矿主可能把不同的parameter所对应的nonce值范围交给不同的矿工去尝试。  
coinbase tx中包含出块奖励收款人的地址，该地址为矿主的地址，所以矿工不提交给矿主，而自己发布出去并没有用，自己也拿不到钱。
如果矿工一开始没有管矿主的任务，自己组装一个区块，收款人地址为自己的地址，那样的话提交的share矿主不会认，因为里面的交易列表被修改过，并且root hash值也不一样。

### 有没有可能某矿工挖到区块后不发布，只提交share作为工作量？
有可能。但是对矿工来说没有任何经济上的好处，可能是矿池之间的竞争，为了打击竞争对手，派矿工到对手矿池分收益。

## 坏处
矿池的存在使得发动51%攻击更容易，只需要召集51%的算力即可，无需自己有51%的算力。
假设某矿池有51%的算力，可以发动的攻击有：
1. forking attack
回滚某个交易
2. Boycott
针对某账户，比如说攻击者不喜欢A账户，怀疑A参与了非法交易，计划把交易封锁掉。他就禁止所有和A账户相关的交易上链，一旦有人把包含A交易的区块发布出去，他就进行分叉攻击，产生另一个不包含A交易的区块。